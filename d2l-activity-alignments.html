<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-polymer-siren-behaviors/store/entity-behavior.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-button/d2l-button.html">
<link rel="import" href="../d2l-button/d2l-button-icon.html">
<link rel="import" href="../d2l-icons/tier1-icons.html">
<link rel="import" href="../d2l-alert/d2l-alert.html">
<link rel="import" href="./d2l-alignment-list.html">
<link rel="import" href="./localize-behavior.html">
<!--
`d2l-select-outcomes`


@demo demo/index.html
-->

<dom-module id="d2l-activity-alignments">
	<template strip-whitespace>
		<style>
			:host {
				display: flex;
			}

			.main {
				flex: 1;
				display: flex;
				flex-direction: column;
				height: 100%;
			}

			[hidden] {
				display: none !important;
			}
		</style>
		<div class="main">
			<d2l-alignment-list hidden$="[[_noAlignments]]" href="[[_getAlignments(entity)]]" token="[[token]]"></d2l-alignment-list>
			<template is="dom-if" if="[[_showError]]">
				<d2l-alert type="error">[[localize('error')]]</d2l-alert>
			</template>
		</div>
	</template>

	<script>
		Polymer({

			is: 'd2l-activity-alignments',

			properties: {
				_showError: {
					type: Boolean,
					value: false
				},
				_noAlignments: {
					type: Boolean,
					value: false
				}
			},

			behaviors: [
				D2L.PolymerBehaviors.Siren.EntityBehavior,
				window.D2L.PolymerBehaviors.SelectOutcomes.LocalizeBehavior,
				window.D2L.Hypermedia.HMConstantsBehavior
			],

			observers: [
				'_fireOnNoAlignments(entity)'
			],

			ready: function() {
				this._boundHandleError = this._handleError.bind(this);
			},

			attached: function() {
				this._showError = false;
				this.addEventListener('d2l-siren-entity-error', this._boundHandleError);
			},

			detached: function() {
				this.removeEventListener('d2l-siren-entity-error', this._boundHandleError);
			},

			_handleError: function(e) {
				if (e.detail.error === 404) {
					this._noAlignments = true;
					this.dispatchEvent(new CustomEvent('d2l-activity-alignments-no-alignments', {
						bubbles: true,
						composed: true,
						detail: {
							href: this.href
						}
					}));
					return;
				}
				this._showError = true;
				this._noAlignments = true;
				this.dispatchEvent(new CustomEvent('d2l-activity-alignments-error', {
					bubbles: true,
					composed: true,
					detail: e.detail
				}));
			},

			_fireOnNoAlignments: function(entity) {
				if (!entity) {
					return;
				}
				if (!this._hasAlignments(entity)) {
					this._noAlignments = true;
					this.dispatchEvent(new CustomEvent('d2l-activity-alignments-no-alignments', {
						bubbles: true,
						composed: true,
						detail: {
							entity: entity
						}
					}));
				} else {
					this._noAlignments = false;
				}
			},

			_hasAlignments: function(entity) {
				return entity && entity.hasLinkByRel(this.HypermediaRels.Alignments.alignments);
			},

			_getAlignments: function(entity) {
				return this._hasAlignments(entity) && entity.getLinkByRel(this.HypermediaRels.Alignments.alignments).href;
			}

		});
	</script>
</dom-module>
